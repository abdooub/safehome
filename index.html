<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SafeHome ‚Äî SPA (Frontend complet)</title>
  <style>
    /* ---- MODE CARDS ----------- */
.mode-card {
    background: #f5faff;
    padding: 25px;
    border-radius: 12px;
    margin: 20px 0;
    border: 1px solid #d6e6ff;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

.mode-title {
    font-size: 20px;
    font-weight: 700;
    color: #1e3a8a;
    margin-bottom: 10px;
}

.mode-desc {
    color: #4a5568;
    margin-bottom: 20px;
    font-size: 14px;
}

/* ---- BIG BUTTONS ---------- */
.btn-big {
    width: 100%;
    background: #1e40af;
    color: white;
    padding: 14px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: .2s;
}

.btn-big:hover {
    background: #1e3a8a;
}

.btn-red {
    background: #dc2626 !important;
}

.btn-red:hover {
    background: #b91c1c !important;
}

/* ---- QUICK ACTIONS -------- */
.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 25px 0;
}

.quick-actions button {
    padding: 10px 20px;
    border-radius: 8px;
    background: #e2e8f0;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: .2s;
}

.quick-actions button:hover {
    background: #cbd5e1;
}

/* ---- CAMERA BOX ----------- */
.camera-box {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    margin-top: 30px;
}

.camera-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tag {
    font-size: 12px;
    background: #2563eb;
    color: white;
    padding: 4px 10px;
    border-radius: 6px;
}

.status-dot {
    width: 12px;
    height: 12px;
    background: #10b981;
    border-radius: 50%;
}

.camera-video img {
    width: 100%;
    border-radius: 10px;
    margin: 15px 0;
}

/* ---- SMALL BUTTON --------- */
.btn-small {
    padding: 10px 20px;
    background: #1e40af;
    color: white;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
}

.btn-small:hover {
    background: #1e3a8a;
}

    :root{
      --bg: #e9f0f6;
      --panel: #ffffff;
      --muted: #6b7280;
      --surface: #f3f7fb;
      --primary: #1976d2;
      --primary-600: #0f62c9;
      --accent: #0b9d58;
      --shadow-1: 0 10px 30px rgba(13,38,59,0.08);
      --shadow-2: 0 6px 18px rgba(15,23,42,0.06);
      --radius-lg: 12px;
      --radius-md: 10px;
      --gap: 18px;
      --max-width: 1180px;
      --font-sans: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --danger: #ef4444;
    }
    [data-theme="dark"]{
      --bg:#0f1724;
      --panel:#0b1220;
      --surface:#071122;
      --muted:#9aa6b2;
      --primary:#4aa3ff;
      color: #e6eef6;
    }
    .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    background: green;
}

.alert-item {
    padding: 8px;
    background: #fff3e0;
    margin-top: 6px;
    border-radius: 4px;
}
.history-item {
    display: grid;
    grid-template-columns: 150px 120px 1fr 120px;
    padding: 12px;
    margin-bottom: 8px;
    background: white;
    border-radius: 6px;
}
.quick-actions button {
    padding: 12px;
    margin: 6px;
    background: #1e88e5;
    color: white;
    border-radius: 6px;
    border: none;
    cursor: pointer;
}

/* Mode active */
.active-mode {
    border: 2px solid #1e88e5;
    background: #e3f2fd;
    transition: 0.3s;
}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font-sans);
      background: linear-gradient(180deg, #e9f3fa 0%, var(--bg) 100%);
      color:#0f1724;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:24px;
      transition:background .18s,color .18s;
    }
    [data-theme="dark"] body{ transition:background .18s,color .18s; }

    a{color:inherit;text-decoration:none}
    .wrap{max-width:var(--max-width);margin:0 auto;display:grid;grid-template-columns:240px 1fr;gap:var(--gap)}
    .sidebar{background:var(--panel);border-radius:var(--radius-lg);padding:18px;box-shadow:var(--shadow-1);height:calc(100vh - 48px);display:flex;flex-direction:column}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#58a2ff);display:grid;place-items:center;color:white;font-weight:700}
    .brand h1{font-size:14px;margin:0}
    .menu{flex:1;display:flex;flex-direction:column;margin-top:16px;gap:6px}
    .menu a{display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;color:var(--muted)}
    .menu a .ico{width:34px;height:34;border-radius:8px;background:var(--surface);display:grid;place-items:center}
    .menu a.active{background:linear-gradient(90deg, rgba(25,118,210,0.07), rgba(11,157,88,0.02));color:var(--primary)}
    .logout{margin-top:auto}
    .logout button{background:transparent;border:0;color:var(--primary);padding:10px;border-radius:8px;cursor:pointer}

    .main{display:flex;flex-direction:column;gap:var(--gap)}
    header.top{display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:var(--radius-lg);background:var(--panel);box-shadow:var(--shadow-2)}
    .page-title{font-size:18px;font-weight:700}
    .top-right{display:flex;align-items:center;gap:12px}
    .avatar{width:40px;height:40px;border-radius:50%;background:#f6fbff;border:2px solid rgba(25,118,210,0.12);display:grid;place-items:center;font-weight:700;color:var(--primary);cursor:pointer}
    .dropdown-menu{position:absolute;right:12px;top:64px;background:var(--panel);box-shadow:var(--shadow-2);padding:8px;border-radius:8px;min-width:160px;display:none}
    .dropdown.open .dropdown-menu{display:block}
    .dropdown-menu a{display:block;padding:8px;border-radius:6px;color:var(--muted)}

    .content{display:grid;gap:var(--gap)}
    .card{background:var(--panel);border-radius:var(--radius-md);padding:14px;box-shadow:var(--shadow-2);border:1px solid rgba(15,23,42,0.03)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center}
    .space{flex:1}

    input[type=text], input[type=password], select, input[type=date]{
      padding:10px;border-radius:8px;border:1px solid #e6eef6;background:linear-gradient(180deg,#fff,#fbfdff);font-size:14px;width:100%;
    }
    button.btn{padding:10px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:transparent;border:1px solid rgba(15,23,42,0.04)}
    .btn-danger{background:var(--danger);color:#fff}

    .cards-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .summary-card{padding:12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center}
    .small-num{font-size:20px;font-weight:800;color:var(--primary-600)}

    .camera{height:220px;border-radius:10px;background:linear-gradient(180deg,#000,#122);color:#fff;position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .camera .tag{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.34);padding:6px 8px;border-radius:8px;font-size:13px}
    .camera .status{position:absolute;right:12px;top:12px;padding:6px 10px;border-radius:8px;font-weight:600;background:rgba(255,255,255,0.06)}
    .camera .status.green{color:#00c853;background:rgba(0,200,83,0.08)}
    .camera .status.red{color:#ff3b30;background:rgba(255,59,48,0.08)}

    .devices-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .device{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:8px;border:1px solid rgba(15,23,42,0.03);background:linear-gradient(180deg,#fff,#fbfdff)}
    .device .meta{display:flex;flex-direction:column}
    .device .meta .name{font-weight:700}
    .device .meta .small{color:var(--muted);font-size:13px}
    .switch{width:46px;height:26px;border-radius:20px;background:#e6eef6;position:relative;cursor:pointer;border:1px solid rgba(15,23,42,0.04)}
    .switch .knob{width:20px;height:20px;border-radius:50%;background:white;position:absolute;top:3px;left:3px;transition:all .18s;box-shadow:0 4px 10px rgba(15,23,42,0.07)}
    .switch.on{background:linear-gradient(90deg,var(--primary),#58a2ff)}
    .switch.on .knob{left:23px}

    .modes-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mode-card{padding:20px;border-radius:10px;display:flex;flex-direction:column;gap:12px;min-height:140px}
    .badge{display:inline-block;padding:6px 10px;border-radius:20px;background:#f1f5f9;color:var(--muted);font-weight:600}

    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600;font-size:13px}

    .profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .small{font-size:13px;color:var(--muted)}

    @media (max-width:980px){
      .wrap{grid-template-columns:1fr;padding:8px}
      .sidebar{display:none}
      .cards-row{grid-template-columns:repeat(2,1fr)}
      .devices-grid{grid-template-columns:1fr}
      .modes-row{grid-template-columns:1fr}
    }

    /* tiny helpers */
    .center{text-align:center}
    .p-sm{padding:8px}
  </style>
</head>
<body>

  <div class="wrap" id="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">SH</div>
        <div>
          <h1>SafeHome</h1>
          <div class="small muted">Smart Home</div>
        </div>
      </div>

      <nav class="menu" id="main-nav">
        <a href="#" data-page="dashboard" class="active"><span class="ico">üè†</span><span>Dashboard</span></a>
        <a href="#" data-page="surveillance"><span class="ico">üì∑</span><span>Surveillance</span></a>
        <a href="#" data-page="controle"><span class="ico">üí°</span><span>Contr√¥le</span></a>
        <a href="#" data-page="modes"><span class="ico">üåô</span><span>Modes</span></a>
        <a href="#" data-page="historique"><span class="ico">üìú</span><span>Historique</span></a>
        <a href="#" data-page="profil"><span class="ico">üë§</span><span>Profil</span></a>
      </nav>

      <div class="logout">
        <button id="btn-logout">D√©connexion</button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="top">
        <div>
          <div class="page-title" id="page-title">Dashboard</div>
          <div class="muted small">R√©sum√© de votre maison</div>
        </div>
        <div class="top-right">
          <div style="font-size:13px;color:var(--muted);text-align:right">Bonjour, <strong id="user-name">Invit√©</strong></div>
          <div class="dropdown" id="user-drop">
            <div class="avatar" id="avatar">R</div>
            <div class="dropdown-menu" id="user-menu">
              <a href="#" data-page="profil" class="menu-link">Profil</a>
              <a href="#" id="toggle-theme">Th√®me Clair/Sombre</a>
              <a href="#" id="logout">D√©connexion</a>
            </div>
          </div>
        </div>
      </header>

      <section class="content">

        <!-- DASHBOARD -->
        <div id="page-dashboard" class="card page">
          <div style="display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap">
            <div style="flex:1;min-width:320px">
              <h2 style="margin:0 0 6px 0">Bonjour, <span id="greet-name">Rania</span></h2>
              <div class="muted small">R√©sum√© rapide</div>

              <div style="margin-top:12px" class="card">
                <h4 style="margin:0 0 10px 0">Connexion rapide (local)</h4>
                <div class="field"><label class="small">Email / Nom d'utilisateur</label><input id="login-user" type="text" placeholder="rania@example.com"></div>
                <div class="field"><label class="small">Mot de passe</label><input id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button class="btn btn-primary" id="do-login">Se connecter</button>
                  <button class="btn btn-ghost" id="demo-login">Demo</button>
                </div>
                <div style="margin-top:8px" class="small muted">Se souvenir? (stock√© localement uniquement)</div>
              </div>
            </div>

            <div style="width:360px">
              <div class="cards-row">
                <div class="card summary-card"><div class="muted">Appareils allum√©s</div><div class="small-num" id="count-on">0</div></div>
                <div class="card summary-card"><div class="muted">Portes ouvertes</div><div class="small-num" id="count-doors">0</div></div>
                <div class="card summary-card"><div class="muted">Alertes aujourd'hui</div><div class="small-num" id="count-alerts">0</div></div>
                <div class="card summary-card"><div class="muted">Mode actif</div><div class="small-num" id="count-mode">Aucun</div></div>
              </div>

              <div style="margin-top:12px" class="card">
                <h4 style="margin:0 0 8px 0">Cam√©ra / Surveillance rapide</h4>
                <div class="camera" id="mini-camera">
                  <div class="tag">En direct</div>
                  <div class="status green" id="mini-status">‚óè Normal</div>
                  <div style="opacity:0.08;font-size:120px">üì∑</div>
                </div>
                <div style="display:flex;gap:8px;margin-top:10px">
                  <button class="btn btn-ghost" onclick="openPage('surveillance')">Voir Surveillance</button>
                  <button class="btn btn-primary" onclick="openPage('surveillance')">Ouvrir Surveillance</button>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- SURVEILLANCE -->
        <div id="page-surveillance" class="card page" style="display:none">
          <h3>Surveillance</h3>
          <div class="muted" style="margin-bottom:8px">Simulation cam√©ra</div>
          <div class="camera" id="main-camera" style="height:380px">
            <div class="tag">En direct</div>
            <div class="status green" id="cam-status">‚óè Normal</div>
            <div style="font-size:18px;color:#fff;opacity:0.9">Image simul√©e / Vid√©o</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <button class="btn" id="cam-pause">Pause</button>
            <button class="btn" id="cam-full">Plein √©cran</button>
            <div style="margin-left:auto" class="muted">Derni√®re alerte : <span id="last-alert">‚Äî</span></div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 320px;gap:12px">
            <div class="card">
              <h4 style="margin-top:0">Alertes de mouvement</h4>
              <div id="alerts-list"></div>
            </div>

            <div class="card">
              <h4 style="margin-top:0">Filtres</h4>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn btn-ghost" onclick="filterAlerts('today')">Aujourd'hui</button>
                <button class="btn btn-ghost" onclick="filterAlerts('7')">7 jours</button>
                <button class="btn btn-ghost" onclick="filterAlerts('all')">Tout</button>
              </div>
            </div>
          </div>
        </div>

        <!-- CONTROLE -->
        <div id="page-controle" class="card page" style="display:none">
          <h3>Contr√¥le des appareils</h3>
          <div class="muted">G√®re l'√©clairage, multim√©dia, chauffage</div>
          <div style="margin-top:12px" class="card">
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
              <div><strong>Ajouter appareil</strong></div>
              <input id="new-device-name" type="text" placeholder="Nom (ex: Salon)" style="width:220px">
              <select id="new-device-type"><option>Light</option><option>TV</option><option>Heater</option><option>Door</option></select>
              <button class="btn btn-primary" id="add-device">Ajouter</button>
              <div style="flex:1"></div>
              <button class="btn btn-danger" id="all-off">√âteindre tous</button>
            </div>
          </div>

          <div style="margin-top:12px" class="devices-grid card" id="devices-container">
            <!-- devices rendered here -->
          </div>
        </div>

        <!-- MODES -->
        <div id="page-modes" class="card page" style="display:none">
          <h3>Modes (Nuit & Absence)</h3>
          <div class="muted">Activer rapidement un mode global</div>
          <div style="margin-top:12px" class="modes-row">
            <div class="mode-card card">
              <div style="display:flex;gap:12px;align-items:center">
                <div style="font-size:28px">üåô</div>
                <div>
                  <div style="font-weight:700">Mode Nuit</div>
                  <div class="muted small">√âteint lumi√®res ¬∑ Ferme portes ¬∑ Active cam√©ras</div>
                </div>
              </div>
              <div style="margin-top:auto;display:flex;gap:8px;align-items:center">
                <div id="badge-night" class="badge">Inactif</div>
                <div style="flex:1"></div>
                <button class="btn btn-primary" onclick="toggleMode('night')">Activer</button>
              </div>
            </div>

            <div class="mode-card card">
              <div style="display:flex;gap:12px;align-items:center">
                <div style="font-size:28px">üè†</div>
                <div>
                  <div style="font-weight:700">Mode Absence</div>
                  <div class="muted small">Ferme portes ¬∑ Active surveillance ¬∑ √âteint lumi√®res</div>
                </div>
              </div>
              <div style="margin-top:auto;display:flex;gap:8px;align-items:center">
                <div id="badge-away" class="badge">Inactif</div>
                <div style="flex:1"></div>
                <button class="btn btn-primary" onclick="toggleMode('away')">Activer</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px" class="card">
            <h4 style="margin-top:0">Historique rapide des modes</h4>
            <ul id="modes-history"></ul>
          </div>
        </div>

        <!-- HISTORIQUE -->
        <div id="page-historique" class="card page" style="display:none">
          <h3>Historique des activit√©s</h3>
          <div style="margin-top:12px" class="card">
            <div style="display:flex;gap:8px;align-items:center">
              <select id="filter-type"><option value="all">Tous</option><option value="device">Appareils</option><option value="door">Porte</option><option value="alert">Alerte</option><option value="mode">Mode</option></select>
              <input id="filter-date" type="date">
              <button class="btn btn-ghost" id="btn-filter">Filtrer</button>
              <div style="flex:1"></div>
              <button class="btn btn-primary" id="export-csv">Exporter CSV</button>
            </div>

            <div style="margin-top:12px" class="table">
              <table id="history-table">
                <thead><tr><th>Date & heure</th><th>Type</th><th>D√©tail</th><th>Utilisateur</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- PROFIL -->
        <div id="page-profil" class="page" style="display:none">
          <div class="profile-grid">
            <div class="card">
              <h3>Informations personnelles</h3>
              <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <div class="field"><label class="small">Nom complet</label><input id="profile-name" type="text" value=""></div>
                <div class="field"><label class="small">Email</label><input id="profile-email" type="text" value=""></div>
                <div class="field"><label class="small">Num√©ro de t√©l√©phone</label><input id="profile-phone" type="text" value=""></div>
                <div class="field"><label class="small">Adresse</label><input id="profile-address" type="text" value=""></div>
              </div>
              <div style="margin-top:12px"><button class="btn btn-primary" id="save-profile">Enregistrer les modifications</button></div>
            </div>

            <div class="card">
              <h3>S√©curit√© du compte</h3>
              <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
                <input id="old-pass" type="password" placeholder="Ancien mot de passe">
                <input id="new-pass" type="password" placeholder="Nouveau mot de passe">
                <input id="confirm-pass" type="password" placeholder="Confirmer le mot de passe">
                <button class="btn btn-primary" id="change-pass">Mettre √† jour le mot de passe</button>
              </div>

              <div style="margin-top:18px">
                <h4>Pr√©f√©rences</h4>
                <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                  <select id="lang-select"><option>Fran√ßais</option><option>Anglais</option></select>
                  <div style="flex:1"></div>
                  <label style="display:flex;align-items:center;gap:8px"><input type="radio" name="theme" value="light"> Clair</label>
                  <label style="display:flex;align-items:center;gap:8px"><input type="radio" name="theme" value="dark"> Sombre</label>
                </div>
              </div>
            </div>
          </div>
        </div>


      </section>
    </main>
  </div><div id="mode-nuit" class="mode-card">
    <div class="mode-title">Mode Nuit</div>
    <p class="mode-desc">√âteint lumi√®res ‚Äì Ferme portes ‚Äì Active cam√©ra</p>
    <button id="btn-nuit" class="btn-big">Activer Mode Nuit</button>
</div>

<div id="mode-absence" class="mode-card">
    <div class="mode-title">Mode Absence</div>
    <p class="mode-desc">Ferme portes ‚Äì Active surveillance ‚Äì √âteint lumi√®res</p>
    <button id="btn-absence" class="btn-big btn-red">D√©sactiver</button>
</div>

<div class="quick-actions">
    <button onclick="turnOffAll()">√âteindre tous les appareils</button>
    <button onclick="closeAllDoors()">Fermer toutes les portes</button>
    <button onclick="activateNightMode()">Activer Mode Nuit</button>
    <button onclick="activateAbsenceMode()">Activer Mode Absence</button>
</div>

<div class="camera-box">
    <div class="camera-header">
        <span class="tag">En direct</span>
        <span id="camera-status" class="status-dot"></span>
    </div>

    <div class="camera-video">
        <img src="camera.jpg" alt="camera" />
    </div>

    <button id="btn-camera" class="btn-small" onclick="toggleCamera()">Pause</button>

    <p id="last-alert">Derni√®re alerte : aucune</p>

    <div id="alert-list"></div>
</div>




<script>
/*
  Frontend-only logic:
  - localStorage keys:
      safe_user, safe_devices, safe_modes, safe_history, safe_profile, safe_theme
  - features:
      login (local), persistent devices, add device, toggle device, modes, history push,
      profile save, export CSV, filters, theme toggle
      
*/
/*---------------------------------------------------
   4. RAPID ACTIONS ‚Äì √âteindre / Fermer / Activer Mode
---------------------------------------------------*/

function logAction(type, detail, user = "Syst√®me") {
    const data = JSON.parse(localStorage.getItem("safehome_history") || "[]");

    data.unshift({
        time: new Date().toLocaleString(),
        type,
        detail,
        user
    });

    localStorage.setItem("safehome_history", JSON.stringify(data));
}
/*---------------------------------------------------
   5. HISTORIQUE ‚Äì System logging + affichage
---------------------------------------------------*/

function loadHistory() {
    const container = document.querySelector("#history-list");
    if (!container) return;

    const data = JSON.parse(localStorage.getItem("safehome_history") || "[]");

    container.innerHTML = "";

    data.forEach(item => {
        container.innerHTML += `
        <div class="history-item">
            <div><strong>${item.time}</strong></div>
            <div>${item.type}</div>
            <div>${item.detail}</div>
            <div>${item.user}</div>
        </div>
        `;
    });
}

document.addEventListener("DOMContentLoaded", loadHistory);
/*---------------------------------------------------
   6. SURVEILLANCE ‚Äì Camera simulation + alerts
---------------------------------------------------*/

let cameraRunning = true;

// change camera status randomly
setInterval(() => {
    if (!cameraRunning) return;

    const hasMotion = Math.random() < 0.2; // 20% chance

    const statusDot = document.querySelector("#camera-status");
    const lastAlert = document.querySelector("#last-alert");
    const alertList = document.querySelector("#alert-list");

    if (hasMotion) {
        statusDot.style.background = "red";
        
        const time = new Date().toLocaleTimeString();
        lastAlert.textContent = "Derni√®re alerte : " + time;

        // push to UI
        alertList.innerHTML = `
            <div class="alert-item">‚ö† Mouvement d√©tect√© ‚Äì ${time}</div>
        ` + alertList.innerHTML;

        // add to history
        logAction("Alerte", "Mouvement d√©tect√©");
    } else {
        statusDot.style.background = "green";
    }

}, 3000);

// pause/resume camera
function toggleCamera() {
    cameraRunning = !cameraRunning;
    document.querySelector("#btn-camera").textContent =
        cameraRunning ? "Pause" : "Reprendre";
}

// turn OFF all devices
function turnOffAll() {
    document.querySelectorAll(".device-switch").forEach(sw => {
        sw.checked = false;
    });

    logAction("Appareil", "Tous les appareils ont √©t√© √©teints");
    alert("Tous les appareils ont √©t√© √©teints !");
}

// close all doors (simulation)
function closeAllDoors() {
    logAction("Portes", "Toutes les portes ont √©t√© ferm√©es");
    alert("Toutes les portes ont √©t√© ferm√©es !");
}

// activate modes fast
function activateNightMode() {
    setActiveMode("nuit");
    logAction("Mode", "Mode Nuit activ√©");
}

function activateAbsenceMode() {
    setActiveMode("absence");
    logAction("Mode", "Mode Absence activ√©");
}



// ---------- Utilities ----------
function nowISO(){ return new Date().toISOString(); }
function formatLocal(iso){
  const d=new Date(iso);
  return d.toLocaleString();
}
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).substr(2,9); }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function load(key, fallback){ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }

// ---------- Initial default state ----------
const DEFAULT_DEVICES = [
  { id: uid('dev'), name:'Salon', type:'Light', on:true, last:'2025-12-06T12:35:00Z' },
  { id: uid('dev'), name:'Cuisine', type:'Light', on:false, last:'2025-12-06T08:21:00Z' },
  { id: uid('dev'), name:'Chambre', type:'Light', on:false, last:'2025-12-06T06:02:00Z' },
  { id: uid('dev'), name:'TV', type:'TV', on:true, last:'2025-12-06T11:10:00Z' },
  { id: uid('dev'), name:'Porte principale', type:'Door', on:false, last:'2025-12-06T11:12:00Z' }
];

function initState(){
  if(!localStorage.getItem('safe_devices')) save('safe_devices', DEFAULT_DEVICES);
  if(!localStorage.getItem('safe_modes')) save('safe_modes', { night:false, away:false, history:[] });
  if(!localStorage.getItem('safe_history')) save('safe_history', []);
  if(!localStorage.getItem('safe_profile')) save('safe_profile', { name:'Rania Al-Farsi', email:'rania.alfarsi@email.com', phone:'+33 6 12 34 56 78', address:'123 Rue de Paix' });
  if(!localStorage.getItem('safe_user')) save('safe_user', { username:'rania', password:'1234' }); // demo user
  if(!localStorage.getItem('safe_theme')) save('safe_theme', 'light');
}
initState();

// ---------- Render helpers ----------
function renderSummary(){
  const devices = load('safe_devices', []);
  const alerts = load('safe_history', []).filter(h=>h.type==='alert');
  const doorsOpen = devices.filter(d=>d.type==='Door' && d.on).length;
  const onCount = devices.filter(d=>d.on).length;
  const modes = load('safe_modes', {night:false,away:false});
  document.getElementById('count-on').textContent = onCount;
  document.getElementById('count-doors').textContent = doorsOpen;
  document.getElementById('count-alerts').textContent = alerts.filter(a => isToday(a.ts)).length;
  document.getElementById('count-mode').textContent = modes.night ? 'Nuit' : (modes.away ? 'Absence' : 'Aucun');
}

function isToday(iso){
  const d=new Date(iso); const now=new Date();
  return d.getDate()===now.getDate() && d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
}

// ---------- Devices rendering & logic ----------
function renderDevices(){
  const container = document.getElementById('devices-container');
  container.innerHTML = '';
  const devices = load('safe_devices', []);
  devices.forEach(dev=>{
    const div = document.createElement('div');
    div.className = 'device';
    div.innerHTML = `
      <div class="meta">
        <div class="name">${escapeHtml(dev.name)} ${dev.type==='Door' ? 'üö™' : ''}</div>
        <div class="small">${dev.type} ¬∑ Derni√®re action : ${dev.last ? formatLocal(dev.last) : '‚Äî'}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-ghost" data-id="${dev.id}" onclick="renameDevice('${dev.id}')">‚úé</button>
        <div class="switch ${dev.on ? 'on' : ''}" data-id="${dev.id}" onclick="toggleDeviceById('${dev.id}', this)">
          <div class="knob"></div>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
  renderSummary();
}

function toggleDeviceById(id, el){
  const devices = load('safe_devices', []);
  const idx = devices.findIndex(d=>d.id===id); if(idx<0) return;
  devices[idx].on = !devices[idx].on;
  devices[idx].last = nowISO();
  save('safe_devices', devices);
  // push history
  pushHistory({
    ts: nowISO(),
    type: devices[idx].type==='Door' ? 'door' : 'device',
    detail: `${devices[idx].name} ${devices[idx].on ? 'allum√©' : '√©teint'}`,
    user: getCurrentUserName()
  });
  renderDevices();
}

function toggleSwitch(el){
  el.classList.toggle('on');
}

document.getElementById('add-device').addEventListener('click', ()=>{
  const name = document.getElementById('new-device-name').value.trim();
  const type = document.getElementById('new-device-type').value;
  if(!name){ alert('Donne un nom √† l\'appareil'); return; }
  const devices = load('safe_devices', []);
  const newDev = { id: uid('dev'), name, type, on:false, last: null };
  devices.push(newDev); save('safe_devices', devices);
  pushHistory({ ts: nowISO(), type:'device', detail:`Ajout√© appareil ${name}`, user:getCurrentUserName() });
  document.getElementById('new-device-name').value = '';
  renderDevices();
});

// rename device (prompt simple)
function renameDevice(id){
  const devices = load('safe_devices', []);
  const d = devices.find(x=>x.id===id);
  if(!d) return;
  const newName = prompt('Nouveau nom pour ' + d.name, d.name);
  if(newName && newName.trim()!==''){
    d.name = newName.trim(); d.last = nowISO();
    save('safe_devices', devices);
    pushHistory({ ts: nowISO(), type:'device', detail:`Renomm√© appareil en ${d.name}`, user:getCurrentUserName() });
    renderDevices();
  }
}

document.getElementById('all-off').addEventListener('click', ()=>{
  const devices = load('safe_devices', []);
  devices.forEach(d=>{ d.on = false; d.last = nowISO(); });
  save('safe_devices', devices);
  pushHistory({ ts: nowISO(), type:'device', detail:'√âteint tous les appareils', user:getCurrentUserName() });
  renderDevices();
});

// ---------- Modes (night / away) ----------
function toggleMode(mode){
  const modes = load('safe_modes', {night:false,away:false,history:[]});
  if(mode==='night'){ modes.night = !modes.night; pushModeHistory('Mode Nuit', modes.night); }
  else { modes.away = !modes.away; pushModeHistory('Mode Absence', modes.away); }
  save('safe_modes', modes);
  // effect: if mode activated, modify devices (example: night -> turn off lights)
  if(modes.night){
    const devices = load('safe_devices', []);
    devices.forEach(d=>{ if(d.type==='Light') { d.on=false; d.last=nowISO(); } });
    save('safe_devices', devices);
  }
  renderDevices(); renderModes();
}
function pushModeHistory(name, active){
  const modes = load('safe_modes', {night:false,away:false,history:[]});
  modes.history = modes.history || [];
  modes.history.unshift({ ts: nowISO(), name, active, user:getCurrentUserName() });
  if(modes.history.length>20) modes.history.pop();
  save('safe_modes', modes);
  pushHistory({ ts: nowISO(), type:'mode', detail:`${name} ${active ? 'activ√©' : 'd√©sactiv√©'}`, user:getCurrentUserName() });
  renderModes();
}
function renderModes(){
  const m = load('safe_modes', {night:false,away:false,history:[]});
  document.getElementById('badge-night').textContent = m.night ? 'Actif' : 'Inactif';
  document.getElementById('badge-away').textContent = m.away ? 'Actif' : 'Inactif';
  const ul = document.getElementById('modes-history'); ul.innerHTML = '';
  (m.history||[]).slice(0,6).forEach(h=>{
    const li = document.createElement('li'); li.textContent = `${formatLocal(h.ts)} ‚Äî ${h.name} ‚Äî ${h.active ? 'Actif' : 'Inactif'}`; ul.appendChild(li);
  });
  renderSummary();
}

// ---------- HISTORY ----------
function pushHistory(entry){
  const hist = load('safe_history', []);
  hist.unshift(entry);
  if(hist.length>500) hist.pop();
  save('safe_history', hist);
  renderHistoryTable();
  // if alert -> update alerts area
  if(entry.type==='alert') renderAlerts();
}

function renderHistoryTable(filter={type:'all', date:null}){
  const hist = load('safe_history', []);
  const tbody = document.querySelector('#history-table tbody'); tbody.innerHTML = '';
  hist.filter(h=>{
    if(filter.type && filter.type!=='all' && h.type!==filter.type) return false;
    if(filter.date){
      const d = new Date(h.ts); const fd = new Date(filter.date);
      if(d.getFullYear()!==fd.getFullYear() || d.getMonth()!==fd.getMonth() || d.getDate()!==fd.getDate()) return false;
    }
    return true;
  }).forEach(h=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${formatLocal(h.ts)}</td><td>${escapeHtml(h.type)}</td><td>${escapeHtml(h.detail)}</td><td>${escapeHtml(h.user||'Syst√®me')}</td>`;
    tbody.appendChild(tr);
  });
}

// filter UI
document.getElementById('btn-filter').addEventListener('click', ()=>{
  const t = document.getElementById('filter-type').value;
  const d = document.getElementById('filter-date').value || null;
  renderHistoryTable({ type: t, date: d });
});

// export CSV
document.getElementById('export-csv').addEventListener('click', ()=>{
  const hist = load('safe_history', []);
  if(hist.length===0){ alert('Aucune donn√©e √† exporter'); return; }
  const rows = [['Date','Type','D√©tail','Utilisateur']];
  hist.forEach(h=> rows.push([formatLocal(h.ts), h.type, h.detail, h.user||'Syst√®me']));
  const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='safe_history.csv'; a.click(); URL.revokeObjectURL(url);
});

// ---------- Alerts (simulated) ----------
function simulateAlert(detail='Mouvement d√©tect√© ‚Äì Entr√©e'){
  const entry = { ts: nowISO(), type:'alert', detail, user:'Syst√®me' };
  pushHistory(entry);
  // show small visual (simple)
  alert('Alerte: ' + detail);
}

function renderAlerts(filter='all'){
  const hist = load('safe_history', []);
  const list = document.getElementById('alerts-list'); list.innerHTML = '';
  hist.filter(h=>h.type==='alert').slice(0,20).forEach(a=>{
    const div = document.createElement('div'); div.className = 'card'; div.style.marginBottom='8px';
    div.innerHTML = `<strong>${formatLocal(a.ts)}</strong><div class="muted">${a.detail}</div>`;
    list.appendChild(div);
  });
  document.getElementById('last-alert').textContent = (hist.find(h=>h.type==='alert') ? formatLocal(hist.find(h=>h.type==='alert').ts) : '‚Äî');
}
function filterAlerts(mode){
  if(mode==='today'){
    const hist = load('safe_history', []).filter(h=>h.type==='alert' && isToday(h.ts));
    // render only these
    const list = document.getElementById('alerts-list'); list.innerHTML='';
    hist.forEach(a=>{
      const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
      div.innerHTML = `<strong>${formatLocal(a.ts)}</strong><div class="muted">${a.detail}</div>`;
      list.appendChild(div);
    });
  } else renderAlerts();
}

// ---------- PROFILE & AUTH (local) ----------
function getCurrentUserName(){ const p=load('safe_profile', {}); return p.name || 'Utilisateur'; }

function renderProfile(){
  const p = load('safe_profile', {});
  document.getElementById('profile-name').value = p.name || '';
  document.getElementById('profile-email').value = p.email || '';
  document.getElementById('profile-phone').value = p.phone || '';
  document.getElementById('profile-address').value = p.address || '';
  document.getElementById('user-name').textContent = p.name ? p.name.split(' ')[0] : 'Invit√©';
  document.getElementById('avatar').textContent = (p.name ? p.name.split(' ').map(x=>x[0]).slice(0,2).join('.') : 'R');
  document.getElementById('greet-name').textContent = p.name ? p.name.split(' ')[0] : 'Invit√©';
}

document.getElementById('save-profile').addEventListener('click', ()=>{
  const p = {
    name: document.getElementById('profile-name').value.trim(),
    email: document.getElementById('profile-email').value.trim(),
    phone: document.getElementById('profile-phone').value.trim(),
    address: document.getElementById('profile-address').value.trim()
  };
  save('safe_profile', p);
  pushHistory({ ts: nowISO(), type:'profile', detail:'Profil mis √† jour', user:getCurrentUserName() });
  renderProfile();
  alert('Profil enregistr√© (local)');
});

// change password (local fake)
document.getElementById('change-pass').addEventListener('click', ()=>{
  const oldp = document.getElementById('old-pass').value;
  const newp = document.getElementById('new-pass').value;
  const conf = document.getElementById('confirm-pass').value;
  const user = load('safe_user', { username:'rania', password:'1234' });
  if(oldp !== user.password){ alert('Ancien mot de passe incorrect'); return; }
  if(newp.length < 4){ alert('Mot de passe trop court'); return; }
  if(newp !== conf){ alert('Confirmation diff√©rente'); return; }
  user.password = newp; save('safe_user', user);
  alert('Mot de passe chang√© (local)');
  pushHistory({ ts: nowISO(), type:'profile', detail:'Mot de passe chang√©', user:getCurrentUserName() });
  document.getElementById('old-pass').value = document.getElementById('new-pass').value = document.getElementById('confirm-pass').value = '';
});

// ---------- LOGIN (local) ----------
document.getElementById('do-login').addEventListener('click', ()=>{
  const u = document.getElementById('login-user').value.trim();
  const p = document.getElementById('login-pass').value;
  const storedUser = load('safe_user', { username:'rania', password:'1234' });
  if(u === storedUser.username && p === storedUser.password){
    localStorage.setItem('safe_logged', '1');
    alert('Connect√© (local)');
    renderAfterAuth();
  } else {
    alert('Identifiants incorrects (demo: rania / 1234)');
  }
});
document.getElementById('demo-login').addEventListener('click', ()=>{
  // demo: set current profile if not exists
  localStorage.setItem('safe_logged', '1');
  renderAfterAuth();
});
document.getElementById('btn-logout').addEventListener('click', ()=>{
  localStorage.removeItem('safe_logged');
  alert('D√©connect√© (local)');
  renderAfterAuth();
});
document.getElementById('logout').addEventListener('click', (e)=>{ e.preventDefault(); localStorage.removeItem('safe_logged'); renderAfterAuth(); });

// show/hide dropdown
document.getElementById('avatar').addEventListener('click', ()=> document.getElementById('user-drop').classList.toggle('open'));

// ---------- THEME ----------
function applyTheme(){
  const theme = load('safe_theme','light');
  document.documentElement.setAttribute('data-theme', theme==='dark' ? 'dark' : 'light');
  // set radio checked
  Array.from(document.getElementsByName('theme')).forEach(r=> r.checked = (r.value === (theme==='dark' ? 'dark' : 'light')));
}
document.getElementById('toggle-theme').addEventListener('click', (e)=>{ e.preventDefault();
  const t = load('safe_theme','light') === 'dark' ? 'light' : 'dark';
  save('safe_theme', t); applyTheme();
});
Array.from(document.getElementsByName('theme')).forEach(r=> r.addEventListener('change', ()=>{
  save('safe_theme', r.value === 'dark' ? 'dark' : 'light'); applyTheme();
}));

// ---------- NAV & view ----------
function openPage(page){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  const el = document.getElementById('page-' + page);
  if(el) el.style.display = 'block';
  document.querySelectorAll('#main-nav a').forEach(a=>a.classList.remove('active'));
  const nav = document.querySelector('#main-nav a[data-page="'+page+'"]');
  if(nav) nav.classList.add('active');
  document.getElementById('page-title').textContent = page.charAt(0).toUpperCase() + page.slice(1);
  // close dropdown
  document.getElementById('user-drop').classList.remove('open');
  // render dependent content
  if(page==='controle') renderDevices();
  if(page==='modes') renderModes();
  if(page==='historique') renderHistoryTable({ type:'all', date:null });
  if(page==='surveillance') renderAlerts();
}

document.querySelectorAll('#main-nav a').forEach(a=>{
  a.addEventListener('click', function(e){ e.preventDefault(); openPage(this.dataset.page); });
});

// ---------- Init after user auth ----------
function renderAfterAuth(){
  const logged = !!localStorage.getItem('safe_logged');
  // if not logged, still let SPA visible but show top login form (we keep everything client-side)
  renderProfile(); renderDevices(); renderModes(); renderHistoryTable({type:'all', date:null}); renderAlerts(); applyTheme();
  renderSummary();
}
renderAfterAuth();

// ---------- Small utilities ----------
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

// simulate occasional alerts (for demo)
setTimeout(()=>simulateAlert('Mouvement d√©tect√© ‚Äî Salon'), 3000);
setTimeout(()=>simulateAlert('Mouvement d√©tect√© ‚Äî Entr√©e'), 9000);

// helper: simulate camera pause/fullscreen
document.getElementById('cam-pause').addEventListener('click', ()=> {
  const s = document.getElementById('cam-status');
  if(s.classList.contains('paused')){ s.classList.remove('paused'); s.textContent='‚óè Normal'; } else { s.classList.add('paused'); s.textContent='‚è∏Ô∏è Pause'; }
});
document.getElementById('cam-full').addEventListener('click', ()=> {
  const el = document.getElementById('main-camera');
  if(el.requestFullscreen) el.requestFullscreen();
});

// small keyboard shortcuts
window.addEventListener('keydown', (e)=> {
  if(e.key === '1') openPage('dashboard');
  if(e.key === '2') openPage('surveillance');
  if(e.key === '3') openPage('controle');
  if(e.key === '4') openPage('modes');
  if(e.key === '5') openPage('historique');
  if(e.key === '6') openPage('profil');
});

// initial render
renderAfterAuth();
/*---------------------------------------------------
   MODE MANAGER ‚Äì Mode Nuit / Mode Absence
---------------------------------------------------*/

// keys used for saving mode
const MODE_KEY = "safehome_active_mode";

// get mode from storage
function getActiveMode() {
    return localStorage.getItem(MODE_KEY) || "none";
}

// save mode
function setActiveMode(mode) {
    localStorage.setItem(MODE_KEY, mode);
    updateModeUI();
    updateDashboardMode();
}

// turn OFF all modes
function resetModes() {
    localStorage.setItem(MODE_KEY, "none");
    updateModeUI();
    updateDashboardMode();
}

/*---------------------------------------------------
   UI UPDATING FOR PAGES
---------------------------------------------------*/
function updateModeUI() {
    const active = getActiveMode();

    const nuitCard = document.querySelector("#mode-nuit");
    const absenceCard = document.querySelector("#mode-absence");

    const nuitBtn = document.querySelector("#btn-nuit");
    const absenceBtn = document.querySelector("#btn-absence");

    // Reset styles
    nuitCard.classList.remove("active-mode");
    absenceCard.classList.remove("active-mode");

    nuitBtn.textContent = "Activer Mode Nuit";
    absenceBtn.textContent = "Activer Mode Absence";

    // Apply active mode
    if (active === "nuit") {
        nuitCard.classList.add("active-mode");
        nuitBtn.textContent = "D√©sactiver";
    }
    if (active === "absence") {
        absenceCard.classList.add("active-mode");
        absenceBtn.textContent = "D√©sactiver";
    }
}

/*---------------------------------------------------
   MODE ACTIONS (Buttons)
---------------------------------------------------*/
document.addEventListener("DOMContentLoaded", () => {

    const btnNuit = document.querySelector("#btn-nuit");
    const btnAbsence = document.querySelector("#btn-absence");

    if (btnNuit) {
        btnNuit.addEventListener("click", () => {
            const active = getActiveMode();
            if (active === "nuit") {
                resetModes();
            } else {
                setActiveMode("nuit");
            }
        });
    }

    if (btnAbsence) {
        btnAbsence.addEventListener("click", () => {
            const active = getActiveMode();
            if (active === "absence") {
                resetModes();
            } else {
                setActiveMode("absence");
            }
        });
    }

    updateModeUI();
    updateDashboardMode();
});

/*---------------------------------------------------
   DASHBOARD MODE DISPLAY
---------------------------------------------------*/
function updateDashboardMode() {
    const dashMode = document.querySelector("#dashboard-mode");

    if (!dashMode) return;

    const active = getActiveMode();

    if (active === "nuit") {
        dashMode.textContent = "Mode Nuit";
        dashMode.style.color = "#1e88e5";
    }
    else if (active === "absence") {
        dashMode.textContent = "Mode Absence";
        dashMode.style.color = "#1e88e5";
    }
    else {
        dashMode.textContent = "Aucun Mode";
        dashMode.style.color = "#666";
    }
}

</script>
</body>
</html>
